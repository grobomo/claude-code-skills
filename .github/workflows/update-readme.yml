name: Update README Plugins Table

on:
  push:
    branches: [main]
    paths:
      - 'plugins/**'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Regenerate plugins table
        run: |
          python3 << 'PYEOF'
          import json, os, re

          plugins = []
          for name in sorted(os.listdir("plugins")):
              pj = f"plugins/{name}/.claude-plugin/plugin.json"
              if not os.path.isfile(pj):
                  continue
              with open(pj) as f:
                  meta = json.load(f)
              plugins.append(meta)

          # Separate standalone and children
          standalone = [p for p in plugins if not p.get("parent")]
          children = [p for p in plugins if p.get("parent")]

          # Build rows
          rows = []
          for p in sorted(standalone, key=lambda x: x["name"].lower()):
              n = p["name"]
              rows.append(f'| **{n}** | {p["description"]} | {p["version"]} | `claude plugin install {n}@grobomo-marketplace` |')
              # Append children of this plugin
              for c in sorted(children, key=lambda x: x["name"].lower()):
                  if c.get("parent") == n:
                      rows.append(f'| &nbsp;&nbsp;&nbsp;&nbsp;{c["name"]} | {c["description"]} | {c["version"]} | *included* |')

          table_lines = [
              "<!-- PLUGINS_TABLE_START -->",
              "| Plugin | Description | Version | Install |",
              "|--------|-------------|---------|---------|",
          ] + rows + [
              "<!-- PLUGINS_TABLE_END -->",
          ]
          table_block = "\n".join(table_lines)

          # Replace in README
          with open("README.md") as f:
              readme = f.read()
          readme = re.sub(
              r"<!-- PLUGINS_TABLE_START -->.*?<!-- PLUGINS_TABLE_END -->",
              table_block,
              readme,
              flags=re.DOTALL,
          )
          with open("README.md", "w") as f:
              f.write(readme)
          print("README updated with", len(rows), "rows")
          PYEOF

      - name: Commit and push if changed
        run: |
          git diff --quiet README.md && exit 0
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: auto-update plugins table in README"
          git push
