name: Update README Plugins Table

on:
  push:
    branches: [main]
    paths:
      - 'plugins/**'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Regenerate plugins table
        run: |
          python3 << 'PYEOF'
          import json, os, re

          plugins = []
          for name in sorted(os.listdir("plugins")):
              pj = f"plugins/{name}/.claude-plugin/plugin.json"
              if not os.path.isfile(pj):
                  continue
              with open(pj) as f:
                  meta = json.load(f)
              plugins.append(meta)

          standalone = sorted([p for p in plugins if not p.get("parent")], key=lambda x: x["name"].lower())
          children = sorted([p for p in plugins if p.get("parent")], key=lambda x: x["name"].lower())

          base = "https://github.com/grobomo/claude-code-skills/tree/main/plugins"

          # Super Manager Ecosystem table
          sm_rows = []
          for p in standalone:
              if p["name"] == "super-manager":
                  n = p["name"]
                  sm_rows.append(f'| **{n}** | {p["description"]} | `claude plugin install {n}@grobomo-marketplace` | [GitHub]({base}/{n}) |')
                  for c in children:
                      if c.get("parent") == "super-manager":
                          cn = c["name"]
                          sm_rows.append(f'| &nbsp;&nbsp;&nbsp;&nbsp;{cn} | {c["description"]} | `claude plugin install {cn}@grobomo-marketplace` (included with super-manager) | [GitHub]({base}/{cn}) |')

          # Standalone table
          other_rows = []
          for p in standalone:
              if p["name"] != "super-manager":
                  n = p["name"]
                  other_rows.append(f'| **{n}** | {p["description"]} | `claude plugin install {n}@grobomo-marketplace` | [GitHub]({base}/{n}) |')

          sm_header = "### Super Manager Ecosystem\n\n| Plugin | Description | Install | Links |\n|--------|-------------|---------|-------|"
          other_header = "### Standalone Plugins\n\n| Plugin | Description | Install | Links |\n|--------|-------------|---------|-------|"

          sm_table = sm_header + "\n" + "\n".join(sm_rows)
          other_table = other_header + "\n" + "\n".join(other_rows)

          table_block = "<!-- PLUGINS_TABLE_START -->\n" + sm_table + "\n\n" + other_table + "\n<!-- PLUGINS_TABLE_END -->"

          with open("README.md") as f:
              readme = f.read()
          readme = re.sub(
              r"<!-- PLUGINS_TABLE_START -->.*?<!-- PLUGINS_TABLE_END -->",
              table_block,
              readme,
              flags=re.DOTALL,
          )
          with open("README.md", "w") as f:
              f.write(readme)
          print("README updated with", len(sm_rows) + len(other_rows), "rows")
          PYEOF

      - name: Commit and push if changed
        run: |
          git diff --quiet README.md && exit 0
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: auto-update plugins table in README"
          git push
